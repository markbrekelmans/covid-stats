<!doctype html>
<html lang="nl">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>COVID-19 trend in Nederland</title>

    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">

    <!--link rel="manifest" href="site.webmanifest"-->
    <!--link rel="apple-touch-icon" href="icon.png"-->

    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      .loader {
        border: 4px solid #f3f3f3; /* Light grey */
        border-top: 4px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
      <a class="navbar-brand" href="#">Menu</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
          </li>
        </ul>
        <form class="form-inline my-2 my-lg-0">
          <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
          <button class="btn btn-secondary my-2 my-sm-0" type="submit">Search</button>
        </form>
      </div>
    </nav><!-- /.nav -->

    <main role="main" class="container">

      <div class="starter-template">
        <h1>COVID-19 trend in Nederland</h1>
        <div class="chart_area" id="chart_A_div">
          <div class="loader"></div>
        </div>

        <div class="chart_area" id="chart_B_div">
          <div class="loader"></div>
        </div>
      </div>

    </main><!-- /.container -->

    <!-- scripts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="/js/vendor/modernizr-3.11.2.min.js"></script>
    <script type="text/javascript" src="/js/plugins.js"></script>
    <script type="text/javascript">
    google.charts.load('current', {'packages': ['table', 'corechart']});

    google.charts.setOnLoadCallback(initiate);

    var options_A = {
      title: 'COVID-19 curve in Nederland vs. exponentiele groei',
      hAxis: {title: 'Totaal gerapporteerde gevallen', logScale: true, baseline: 1, format: 'short'},
      vAxis: {title: 'Nieuw gerapporteerde gevallen \n(afgelopen week)', logScale: true, baseline: 1, format: 'short'},
      legend: 'bottom',
      interpolateNulls: true,
      series: {
        0: {color: '#556F44'},
        1: {color: '#99DDC8', lineDashStyle: [2,1]}
      },
      width: window.innerWidth-200,
      height: 400
    }

    var options_B = {
      title: 'Nieuw gerapporteerde gevallen in de afgelopen week',
      hAxis: {title: 'Rapportage datum'},
      vAxis: {title: 'Nieuw gerapporteerde gevallen \n(afgelopen week)', logScale: false, baseline: 1, format: 'short'},
      legend: 'bottom',
      interpolateNulls: true,
      series: {
        0: {color: '#556F44'}
      },
      width: window.innerWidth-200,
      height: 400
    }

    function initiate() {
      $.get('https://data.rivm.nl/covid-19/COVID-19_aantallen_gemeente_cumulatief.csv', function(csvData) {
        var arrData = $.csv.toArrays(csvData, {'separator': ';', onParseValue: $.csv.hooks.castToScalar});

        var dtA = new google.visualization.DataTable();
        dtA.addColumn('date', 'Date');
        dtA.addColumn('number', 'Totaal aantal gevallen');

        dtA.addRows([
          [new Date('2020-03-05'), 82],
          [new Date('2020-03-06'), 128],
          [new Date('2020-03-07'), 188],
          [new Date('2020-03-08'), 265],
          [new Date('2020-03-09'), 321],
          [new Date('2020-03-10'), 382],
          [new Date('2020-03-11'), 503],
          [new Date('2020-03-12'), 503]
        ]);

        for(var r=1; r<arrData.length; r++) {
          dtA.addRow([
            new Date(arrData[r][0].substring(0,10)),
            arrData[r][4]
          ])
        }

        var dtA = google.visualization.data.group(
          dtA, [0], [{'column': 1, 'aggregation': google.visualization.data.sum, 'type': 'number'}]
        );

        var dvA = new google.visualization.DataView(dtA);
        dvA.setColumns([
          1,
          {
            calc: deltaPrev,
            type: 'number',
            label: 'Nieuwe gevallen'
          },
          0
        ]);

        function deltaPrev(dtA, rowNum){
          return (rowNum<7) ? Math.floor(dtA.getValue(rowNum, 1) - dtA.getValue(0, 1)) : Math.floor(dtA.getValue(rowNum, 1) - dtA.getValue(Math.max(0,rowNum-7), 1));
        }

        //
        // set-up table and view B
        //
        $.get('/data/logref.csv', function(csvData) {
          var arrData = $.csv.toArrays(csvData, {'separator': ';', onParseValue: $.csv.hooks.castToScalar});
          var dtB = new google.visualization.DataTable();
          dtB.addColumn('number', 'Totaal aantal gevallen');
          dtB.addColumn('number', 'Exponentiele groei');

          for(var r=0; r<arrData.length; r++) {
            dtB.addRow([
              arrData[r][0],
              arrData[r][1]
            ])
          }

          var dvB = new google.visualization.DataView(dtB);

          var dvC = new google.visualization.data.join(dvA,dvB,'full',[[0,0]],[1],[1]);

          var dvD = dvA;
          dvD.setColumns([
            0,
            {
              calc: deltaPrev,
              type: 'number',
              label: 'Nieuwe gevallen'
            }
          ]);

          //
          // draw the chart
          //
          var chartA = new google.visualization.LineChart(document.getElementById('chart_A_div'));
          chartA.draw(dvC, options_A);

          var chartB = new google.visualization.LineChart(document.getElementById('chart_B_div'));
          chartB.draw(dvD, options_B);
        });
      });
    }

    window.onresize = function(event) {
        initiate();
    }
    </script>
  </body>
</html>
